


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="img/sanofi.svg">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.2.2">
    
    
      
        <title>Formats - DRAFT AllStar速 Connect - Interoperability Manual</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.b8fb47b5.min.css">
      
        <link rel="stylesheet" href="assets/stylesheets/palette.36d1b78f.min.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Hammersmith+One:300,400,400i,700%7CHammersmith+One&display=fallback">
        <style>body,input{font-family:"Hammersmith One",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Hammersmith One",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="css/style.css">
    
      <link rel="stylesheet" href="css/jquery.fancybox.min.css">
    
      <link rel="stylesheet" href="css/bootstrap.min.css">
    
      <link rel="stylesheet" href="css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementation-checklist" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<div class="logo-wrapper">
  <a href="index.html">
    <img src='img/logo.png' width="200">
  </a>
</div>
 

<!-- Application header -->

	
  <!-- Top-level navigation -->

	
<nav class="navbar sticky-top navbar-expand-md navbar-light ">



    <button class="navbar-toggler float-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown">
      <span class="navbar-toggler-icon"></span>
  </button>

    <div class="navbar-collapse collapse" id="navbarNavDropdown">
      <ul class="nav navbar-nav navbar-center">
       
 

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle-split" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            EUROPE
          </a>
          <span class="sr-only">Toggle Dropdown</span>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="#">Action</a>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link" href="asia.html" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            ASIA
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="cambodia.html">Cambodia</a>
            <a class="dropdown-item" href="#">b</a>
            <a class="dropdown-item" href="#">c</a>
          </div>
        </li>
          <li class="nav-item dropdown">
            <a class="nav-link" href="north-america.html" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              NORTH AMERICA
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="canada.html">Canada</a>
              <a class="dropdown-item" href="#">Puerto Rico</a>
              <a class="dropdown-item" href="#">US</a>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              AFRICA
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="#">Action</a>
              <a class="dropdown-item" href="#">Another action</a>
              <a class="dropdown-item" href="#">Something else here</a>
            </div>
          </li>
            <li class="nav-item">
              <a class="nav-link" href="video.html">VIDEO</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="contact.html">CONTACT</a>
            </li>
      </ul>
    </div>

</nav>




    <!-- Link to home 
    <a

	  href="index.html"
      title="DRAFT AllStar速 Connect - Interoperability Manual"
      aria-label="DRAFT AllStar速 Connect - Interoperability Manual"
      class="md-header-nav__button md-logo"
    >
      
        <img src="img/sanofi_white.svg" alt="logo" />
      
    </a>
   

    <!-- Header title 
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis md-ellipsis">
        
          <span class="md-header-nav__topic">
            DRAFT AllStar速 Connect - Interoperability Manual
          </span>
          <span class="md-header-nav__topic">
            
              Formats
            
          </span>
        
      </div>
    </div>

    <!-- Button to open search dialogue -->


    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
        
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h2 id="implementation-checklist">Implementation Checklist<a class="headerlink" href="#implementation-checklist" title="Permanent link">#</a></h2>
<p>The following items give an overview of the of most critical items that need to be addressed at a minimum:</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Can you successfully pair with an AllStar&reg; Connect?</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Can you successfully sync dose records from an AllStar&reg; Connect?</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Have you mitigated all patient safety risks? (see <a href="technical_overview.html#use-related-risks">here</a>)<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Risk #1</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Risk #2</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Risk #3</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Risk #4</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Risk #5</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Risk #6</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Risk #7</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Risk #8</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Risk #9</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Have you implemented handling of all error flags and error codes? </li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Have you implemented handling the end of life of the AllStar&reg; Connect<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Low/empty battery</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Dose Record Storage full</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Expiration date not exceeded</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Warehouse time not exceeded</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> Do you track and provide PTC relevant data?</li>
</ul>
<hr />
<div class="admonition example example tab breaks">
<p class="admonition-title">Example</p>
<div class="tabbed-set" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Tab 1</label><div class="tabbed-content">
<p>Markdown <strong>content</strong>.</p>
<p>Multiple paragraphs.</p>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">Tab 2</label><div class="tabbed-content">
<p>More Markdown <strong>content</strong>.</p>
<ul>
<li>list item a</li>
<li>list item b</li>
</ul>
</div>
</div>
<div class="tabbed-set" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">Tab A</label><div class="tabbed-content">
<p>Different tab set.</p>
</div>
<input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><label for="__tabbed_2_2">Tab B</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>More content.
</code></pre></div>
</td></tr></table>

</div>
</div>
</div>
<div class="tabbed-set" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><label for="__tabbed_3_1">Bash</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">STR</span><span class="o">=</span><span class="s2">&quot;Hello World!&quot;</span>
<span class="nb">echo</span> <span class="nv">$STR</span>
</code></pre></div>
</td></tr></table>

</div>
<input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><label for="__tabbed_3_2">C</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cp">#include</span> 

<span class="cpf">int main(void) {</span><span class="cp"></span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hello, world</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>

</div>
</div>
<hr />
<h2 id="sequence-android">Sequence - Android<a class="headerlink" href="#sequence-android" title="Permanent link">#</a></h2>
<div class="tabbed-set" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><label for="__tabbed_4_1">1. Scan</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code> <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">        FUNCTION: startScan</span>
<span class="cm">        Description: Called when the state button is pressed. Sets the state to OPEN_SCANNING which </span>
<span class="cm">        triggers the state machine to start a scan for any available devices.</span>
<span class="cm">        Param: None</span>
<span class="cm">        Return: None</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">startScan</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">mState</span> <span class="p">=</span> <span class="n">STATE</span><span class="p">.</span><span class="n">OPEN_SCANNING</span><span class="p">;</span>
            <span class="n">Log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;Open Scanning...&quot;</span><span class="p">);</span>
            <span class="n">mDiscoveredDevices</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

            <span class="c1">// Clear the list</span>
            <span class="n">RunOnUiThread</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">emptyList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
                <span class="n">ListAdapter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ArrayAdapter</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">,</span>
                                                       <span class="n">Resource</span><span class="p">.</span><span class="n">Layout</span><span class="p">.</span><span class="n">ListItemLayout</span><span class="p">,</span>
                                                       <span class="n">emptyList</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="c1">// Check bluetooth is enabled</span>
            <span class="n">BluetoothAdapter</span> <span class="n">adapter</span> <span class="p">=</span> <span class="n">BluetoothAdapter</span><span class="p">.</span><span class="n">DefaultAdapter</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">adapter</span><span class="p">.</span><span class="n">IsEnabled</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">BluetoothLeScanner</span> <span class="n">bleScanner</span> <span class="p">=</span> <span class="n">adapter</span><span class="p">.</span><span class="n">BluetoothLeScanner</span><span class="p">;</span>
                <span class="n">BleScanCallback</span> <span class="n">bleScanCallback</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BleScanCallback</span><span class="p">();</span>

                <span class="c1">// Start scanning for devices advertising the dose info service</span>
                <span class="n">ScanFilter</span> <span class="n">filter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ScanFilter</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">SetServiceUuid</span><span class="p">(</span><span class="k">new</span> <span class="n">ParcelUuid</span><span class="p">(</span><span class="n">mDoseInfoServiceUUID</span><span class="p">)).</span><span class="n">Build</span><span class="p">();</span>
                <span class="n">List</span><span class="p">&lt;</span><span class="n">ScanFilter</span><span class="p">&gt;</span> <span class="n">filterList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ScanFilter</span><span class="p">&gt;();</span>
                <span class="n">filterList</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>

                <span class="n">ScanSettings</span> <span class="n">settings</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ScanSettings</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">Build</span><span class="p">();</span>

                <span class="n">bleScanner</span><span class="p">.</span><span class="n">StartScan</span><span class="p">(</span><span class="n">filterList</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">bleScanCallback</span><span class="p">);</span>


                <span class="c1">// Stop after the scan timeout (converted to ms)</span>
                <span class="n">Thread</span> <span class="n">deviceListThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">AppSettings</span><span class="p">.</span><span class="n">SCAN_TIMEOUT</span> <span class="p">*</span> <span class="m">1000</span><span class="p">);</span>
                    <span class="n">Log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;Stopping scan...&quot;</span><span class="p">);</span>
                    <span class="n">bleScanner</span><span class="p">.</span><span class="n">StopScan</span><span class="p">(</span><span class="n">bleScanCallback</span><span class="p">);</span>

                    <span class="c1">// Get the list of discovered devices</span>
                    <span class="n">mDiscoveredDevices</span> <span class="p">=</span> <span class="n">bleScanCallback</span><span class="p">.</span><span class="n">getDiscoveredDevices</span><span class="p">();</span>
                    <span class="n">mState</span> <span class="p">=</span> <span class="n">STATE</span><span class="p">.</span><span class="n">USER_INPUT</span><span class="p">;</span>
                <span class="p">});</span>
                <span class="n">deviceListThread</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Device list thread&quot;</span><span class="p">;</span>
                <span class="n">deviceListThread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>
</td></tr></table>

</div>
<input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><label for="__tabbed_4_2">2. Pairing</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            FUNCTION: pairTask</span>
<span class="cm">            Description: Performs the pairing</span>
<span class="cm">            Return: None</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">pairTask</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">mGattCallback</span><span class="p">.</span><span class="n">gConnectionAlive</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">mGatt</span> <span class="p">=</span> <span class="n">selectedDevice</span><span class="p">.</span><span class="n">ConnectGatt</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">mGattCallback</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">mState</span> <span class="p">=</span> <span class="n">STATE</span><span class="p">.</span><span class="n">PAIRING</span><span class="p">;</span>

            <span class="n">DateTime</span> <span class="n">startTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
            <span class="n">DateTime</span> <span class="n">currentTime</span> <span class="p">=</span> <span class="n">startTime</span><span class="p">;</span>

            <span class="n">Thread</span> <span class="n">pairThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">while</span> <span class="p">((!</span><span class="n">mGattCallback</span><span class="p">.</span><span class="n">gAuthenticationComplete</span><span class="p">)</span> <span class="p">&amp;&amp;</span> 
                       <span class="p">(</span><span class="n">currentTime</span><span class="p">.</span><span class="n">Subtract</span><span class="p">(</span><span class="n">startTime</span><span class="p">).</span><span class="n">Seconds</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="cm">/* Wait for the pairing to succeed or time out */</span>
                    <span class="n">currentTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Finished Pairing&quot;</span><span class="p">);</span>

                <span class="cm">/* Determine whether pairing was successful and display the appropirate message */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="n">getBondState</span><span class="p">()</span> <span class="p">==</span> <span class="n">Bond</span><span class="p">.</span><span class="n">Bonded</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Thread</span> <span class="n">keyStoreThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span>
                    <span class="p">{</span>
                        <span class="n">StoreEncryptionKey</span><span class="p">();</span>
                    <span class="p">});</span>
                    <span class="n">keyStoreThread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>

                    <span class="cm">/* Display the dialoge */</span>
                    <span class="n">displayPairingSuccess</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">mGatt</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">mGatt</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
                        <span class="n">mGatt</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">displayPairingFailed</span><span class="p">(</span><span class="s">&quot;Pairing was not successful&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
            <span class="n">pairThread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="p">}</span>
</code></pre></div>
</td></tr></table>

</div>
</div>
<hr />
<h2 id="crc-check">CRC check<a class="headerlink" href="#crc-check" title="Permanent link">#</a></h2>
<div class="tabbed-set" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><label for="__tabbed_5_1">C# (Android)</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code> <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">        FUNCTION: checkCRC</span>
<span class="cm">        Description: Checks the CRC of a given data set with CRC in the last byte</span>
<span class="cm">        Param: Data - the data on which to check the CRC</span>
<span class="cm">        Return: bool - true if the CRC is valid, false otherwise</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>

 <span class="k">private</span> <span class="k">static</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">mCrcTable</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="m">256</span><span class="p">]</span> <span class="p">{</span>
            <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x97</span><span class="p">,</span> <span class="m">0</span><span class="n">xb9</span><span class="p">,</span> <span class="m">0</span><span class="n">x2e</span><span class="p">,</span> <span class="m">0</span><span class="n">xe5</span><span class="p">,</span> <span class="m">0</span><span class="n">x72</span><span class="p">,</span> <span class="m">0</span><span class="n">x5c</span><span class="p">,</span> <span class="m">0</span><span class="n">xcb</span><span class="p">,</span> <span class="m">0</span><span class="n">x5d</span><span class="p">,</span> <span class="m">0</span><span class="n">xca</span><span class="p">,</span> <span class="m">0</span><span class="n">xe4</span><span class="p">,</span> <span class="m">0</span><span class="n">x73</span><span class="p">,</span> <span class="m">0</span><span class="n">xb8</span><span class="p">,</span> <span class="m">0</span><span class="n">x2f</span><span class="p">,</span> <span class="m">0</span><span class="n">x01</span><span class="p">,</span> <span class="m">0</span><span class="n">x96</span><span class="p">,</span>
            <span class="m">0</span><span class="n">xba</span><span class="p">,</span> <span class="m">0</span><span class="n">x2d</span><span class="p">,</span> <span class="m">0</span><span class="n">x03</span><span class="p">,</span> <span class="m">0</span><span class="n">x94</span><span class="p">,</span> <span class="m">0</span><span class="n">x5f</span><span class="p">,</span> <span class="m">0</span><span class="n">xc8</span><span class="p">,</span> <span class="m">0</span><span class="n">xe6</span><span class="p">,</span> <span class="m">0</span><span class="n">x71</span><span class="p">,</span> <span class="m">0</span><span class="n">xe7</span><span class="p">,</span> <span class="m">0</span><span class="n">x70</span><span class="p">,</span> <span class="m">0</span><span class="n">x5e</span><span class="p">,</span> <span class="m">0</span><span class="n">xc9</span><span class="p">,</span> <span class="m">0</span><span class="n">x02</span><span class="p">,</span> <span class="m">0</span><span class="n">x95</span><span class="p">,</span> <span class="m">0</span><span class="n">xbb</span><span class="p">,</span> <span class="m">0</span><span class="n">x2c</span><span class="p">,</span>
            <span class="m">0</span><span class="n">xe3</span><span class="p">,</span> <span class="m">0</span><span class="n">x74</span><span class="p">,</span> <span class="m">0</span><span class="n">x5a</span><span class="p">,</span> <span class="m">0</span><span class="n">xcd</span><span class="p">,</span> <span class="m">0</span><span class="n">x06</span><span class="p">,</span> <span class="m">0</span><span class="n">x91</span><span class="p">,</span> <span class="m">0</span><span class="n">xbf</span><span class="p">,</span> <span class="m">0</span><span class="n">x28</span><span class="p">,</span> <span class="m">0</span><span class="n">xbe</span><span class="p">,</span> <span class="m">0</span><span class="n">x29</span><span class="p">,</span> <span class="m">0</span><span class="n">x07</span><span class="p">,</span> <span class="m">0</span><span class="n">x90</span><span class="p">,</span> <span class="m">0</span><span class="n">x5b</span><span class="p">,</span> <span class="m">0</span><span class="n">xcc</span><span class="p">,</span> <span class="m">0</span><span class="n">xe2</span><span class="p">,</span> <span class="m">0</span><span class="n">x75</span><span class="p">,</span>
            <span class="m">0</span><span class="n">x59</span><span class="p">,</span> <span class="m">0</span><span class="n">xce</span><span class="p">,</span> <span class="m">0</span><span class="n">xe0</span><span class="p">,</span> <span class="m">0</span><span class="n">x77</span><span class="p">,</span> <span class="m">0</span><span class="n">xbc</span><span class="p">,</span> <span class="m">0</span><span class="n">x2b</span><span class="p">,</span> <span class="m">0</span><span class="n">x05</span><span class="p">,</span> <span class="m">0</span><span class="n">x92</span><span class="p">,</span> <span class="m">0</span><span class="n">x04</span><span class="p">,</span> <span class="m">0</span><span class="n">x93</span><span class="p">,</span> <span class="m">0</span><span class="n">xbd</span><span class="p">,</span> <span class="m">0</span><span class="n">x2a</span><span class="p">,</span> <span class="m">0</span><span class="n">xe1</span><span class="p">,</span> <span class="m">0</span><span class="n">x76</span><span class="p">,</span> <span class="m">0</span><span class="n">x58</span><span class="p">,</span> <span class="m">0</span><span class="n">xcf</span><span class="p">,</span>
            <span class="m">0</span><span class="n">x51</span><span class="p">,</span> <span class="m">0</span><span class="n">xc6</span><span class="p">,</span> <span class="m">0</span><span class="n">xe8</span><span class="p">,</span> <span class="m">0</span><span class="n">x7f</span><span class="p">,</span> <span class="m">0</span><span class="n">xb4</span><span class="p">,</span> <span class="m">0</span><span class="n">x23</span><span class="p">,</span> <span class="m">0</span><span class="n">x0d</span><span class="p">,</span> <span class="m">0</span><span class="n">x9a</span><span class="p">,</span> <span class="m">0</span><span class="n">x0c</span><span class="p">,</span> <span class="m">0</span><span class="n">x9b</span><span class="p">,</span> <span class="m">0</span><span class="n">xb5</span><span class="p">,</span> <span class="m">0</span><span class="n">x22</span><span class="p">,</span> <span class="m">0</span><span class="n">xe9</span><span class="p">,</span> <span class="m">0</span><span class="n">x7e</span><span class="p">,</span> <span class="m">0</span><span class="n">x50</span><span class="p">,</span> <span class="m">0</span><span class="n">xc7</span><span class="p">,</span>
            <span class="m">0</span><span class="n">xeb</span><span class="p">,</span> <span class="m">0</span><span class="n">x7c</span><span class="p">,</span> <span class="m">0</span><span class="n">x52</span><span class="p">,</span> <span class="m">0</span><span class="n">xc5</span><span class="p">,</span> <span class="m">0</span><span class="n">x0e</span><span class="p">,</span> <span class="m">0</span><span class="n">x99</span><span class="p">,</span> <span class="m">0</span><span class="n">xb7</span><span class="p">,</span> <span class="m">0</span><span class="n">x20</span><span class="p">,</span> <span class="m">0</span><span class="n">xb6</span><span class="p">,</span> <span class="m">0</span><span class="n">x21</span><span class="p">,</span> <span class="m">0</span><span class="n">x0f</span><span class="p">,</span> <span class="m">0</span><span class="n">x98</span><span class="p">,</span> <span class="m">0</span><span class="n">x53</span><span class="p">,</span> <span class="m">0</span><span class="n">xc4</span><span class="p">,</span> <span class="m">0</span><span class="n">xea</span><span class="p">,</span> <span class="m">0</span><span class="n">x7d</span><span class="p">,</span>
            <span class="m">0</span><span class="n">xb2</span><span class="p">,</span> <span class="m">0</span><span class="n">x25</span><span class="p">,</span> <span class="m">0</span><span class="n">x0b</span><span class="p">,</span> <span class="m">0</span><span class="n">x9c</span><span class="p">,</span> <span class="m">0</span><span class="n">x57</span><span class="p">,</span> <span class="m">0</span><span class="n">xc0</span><span class="p">,</span> <span class="m">0</span><span class="n">xee</span><span class="p">,</span> <span class="m">0</span><span class="n">x79</span><span class="p">,</span> <span class="m">0</span><span class="n">xef</span><span class="p">,</span> <span class="m">0</span><span class="n">x78</span><span class="p">,</span> <span class="m">0</span><span class="n">x56</span><span class="p">,</span> <span class="m">0</span><span class="n">xc1</span><span class="p">,</span> <span class="m">0</span><span class="n">x0a</span><span class="p">,</span> <span class="m">0</span><span class="n">x9d</span><span class="p">,</span> <span class="m">0</span><span class="n">xb3</span><span class="p">,</span> <span class="m">0</span><span class="n">x24</span><span class="p">,</span>
            <span class="m">0</span><span class="n">x08</span><span class="p">,</span> <span class="m">0</span><span class="n">x9f</span><span class="p">,</span> <span class="m">0</span><span class="n">xb1</span><span class="p">,</span> <span class="m">0</span><span class="n">x26</span><span class="p">,</span> <span class="m">0</span><span class="n">xed</span><span class="p">,</span> <span class="m">0</span><span class="n">x7a</span><span class="p">,</span> <span class="m">0</span><span class="n">x54</span><span class="p">,</span> <span class="m">0</span><span class="n">xc3</span><span class="p">,</span> <span class="m">0</span><span class="n">x55</span><span class="p">,</span> <span class="m">0</span><span class="n">xc2</span><span class="p">,</span> <span class="m">0</span><span class="n">xec</span><span class="p">,</span> <span class="m">0</span><span class="n">x7b</span><span class="p">,</span> <span class="m">0</span><span class="n">xb0</span><span class="p">,</span> <span class="m">0</span><span class="n">x27</span><span class="p">,</span> <span class="m">0</span><span class="n">x09</span><span class="p">,</span> <span class="m">0</span><span class="n">x9e</span><span class="p">,</span>
            <span class="m">0</span><span class="n">xa2</span><span class="p">,</span> <span class="m">0</span><span class="n">x35</span><span class="p">,</span> <span class="m">0</span><span class="n">x1b</span><span class="p">,</span> <span class="m">0</span><span class="n">x8c</span><span class="p">,</span> <span class="m">0</span><span class="n">x47</span><span class="p">,</span> <span class="m">0</span><span class="n">xd0</span><span class="p">,</span> <span class="m">0</span><span class="n">xfe</span><span class="p">,</span> <span class="m">0</span><span class="n">x69</span><span class="p">,</span> <span class="m">0</span><span class="n">xff</span><span class="p">,</span> <span class="m">0</span><span class="n">x68</span><span class="p">,</span> <span class="m">0</span><span class="n">x46</span><span class="p">,</span> <span class="m">0</span><span class="n">xd1</span><span class="p">,</span> <span class="m">0</span><span class="n">x1a</span><span class="p">,</span> <span class="m">0</span><span class="n">x8d</span><span class="p">,</span> <span class="m">0</span><span class="n">xa3</span><span class="p">,</span> <span class="m">0</span><span class="n">x34</span><span class="p">,</span>
            <span class="m">0</span><span class="n">x18</span><span class="p">,</span> <span class="m">0</span><span class="n">x8f</span><span class="p">,</span> <span class="m">0</span><span class="n">xa1</span><span class="p">,</span> <span class="m">0</span><span class="n">x36</span><span class="p">,</span> <span class="m">0</span><span class="n">xfd</span><span class="p">,</span> <span class="m">0</span><span class="n">x6a</span><span class="p">,</span> <span class="m">0</span><span class="n">x44</span><span class="p">,</span> <span class="m">0</span><span class="n">xd3</span><span class="p">,</span> <span class="m">0</span><span class="n">x45</span><span class="p">,</span> <span class="m">0</span><span class="n">xd2</span><span class="p">,</span> <span class="m">0</span><span class="n">xfc</span><span class="p">,</span> <span class="m">0</span><span class="n">x6b</span><span class="p">,</span> <span class="m">0</span><span class="n">xa0</span><span class="p">,</span> <span class="m">0</span><span class="n">x37</span><span class="p">,</span> <span class="m">0</span><span class="n">x19</span><span class="p">,</span> <span class="m">0</span><span class="n">x8e</span><span class="p">,</span>
            <span class="m">0</span><span class="n">x41</span><span class="p">,</span> <span class="m">0</span><span class="n">xd6</span><span class="p">,</span> <span class="m">0</span><span class="n">xf8</span><span class="p">,</span> <span class="m">0</span><span class="n">x6f</span><span class="p">,</span> <span class="m">0</span><span class="n">xa4</span><span class="p">,</span> <span class="m">0</span><span class="n">x33</span><span class="p">,</span> <span class="m">0</span><span class="n">x1d</span><span class="p">,</span> <span class="m">0</span><span class="n">x8a</span><span class="p">,</span> <span class="m">0</span><span class="n">x1c</span><span class="p">,</span> <span class="m">0</span><span class="n">x8b</span><span class="p">,</span> <span class="m">0</span><span class="n">xa5</span><span class="p">,</span> <span class="m">0</span><span class="n">x32</span><span class="p">,</span> <span class="m">0</span><span class="n">xf9</span><span class="p">,</span> <span class="m">0</span><span class="n">x6e</span><span class="p">,</span> <span class="m">0</span><span class="n">x40</span><span class="p">,</span> <span class="m">0</span><span class="n">xd7</span><span class="p">,</span>
            <span class="m">0</span><span class="n">xfb</span><span class="p">,</span> <span class="m">0</span><span class="n">x6c</span><span class="p">,</span> <span class="m">0</span><span class="n">x42</span><span class="p">,</span> <span class="m">0</span><span class="n">xd5</span><span class="p">,</span> <span class="m">0</span><span class="n">x1e</span><span class="p">,</span> <span class="m">0</span><span class="n">x89</span><span class="p">,</span> <span class="m">0</span><span class="n">xa7</span><span class="p">,</span> <span class="m">0</span><span class="n">x30</span><span class="p">,</span> <span class="m">0</span><span class="n">xa6</span><span class="p">,</span> <span class="m">0</span><span class="n">x31</span><span class="p">,</span> <span class="m">0</span><span class="n">x1f</span><span class="p">,</span> <span class="m">0</span><span class="n">x88</span><span class="p">,</span> <span class="m">0</span><span class="n">x43</span><span class="p">,</span> <span class="m">0</span><span class="n">xd4</span><span class="p">,</span> <span class="m">0</span><span class="n">xfa</span><span class="p">,</span> <span class="m">0</span><span class="n">x6d</span><span class="p">,</span>
            <span class="m">0</span><span class="n">xf3</span><span class="p">,</span> <span class="m">0</span><span class="n">x64</span><span class="p">,</span> <span class="m">0</span><span class="n">x4a</span><span class="p">,</span> <span class="m">0</span><span class="n">xdd</span><span class="p">,</span> <span class="m">0</span><span class="n">x16</span><span class="p">,</span> <span class="m">0</span><span class="n">x81</span><span class="p">,</span> <span class="m">0</span><span class="n">xaf</span><span class="p">,</span> <span class="m">0</span><span class="n">x38</span><span class="p">,</span> <span class="m">0</span><span class="n">xae</span><span class="p">,</span> <span class="m">0</span><span class="n">x39</span><span class="p">,</span> <span class="m">0</span><span class="n">x17</span><span class="p">,</span> <span class="m">0</span><span class="n">x80</span><span class="p">,</span> <span class="m">0</span><span class="n">x4b</span><span class="p">,</span> <span class="m">0</span><span class="n">xdc</span><span class="p">,</span> <span class="m">0</span><span class="n">xf2</span><span class="p">,</span> <span class="m">0</span><span class="n">x65</span><span class="p">,</span>
            <span class="m">0</span><span class="n">x49</span><span class="p">,</span> <span class="m">0</span><span class="n">xde</span><span class="p">,</span> <span class="m">0</span><span class="n">xf0</span><span class="p">,</span> <span class="m">0</span><span class="n">x67</span><span class="p">,</span> <span class="m">0</span><span class="n">xac</span><span class="p">,</span> <span class="m">0</span><span class="n">x3b</span><span class="p">,</span> <span class="m">0</span><span class="n">x15</span><span class="p">,</span> <span class="m">0</span><span class="n">x82</span><span class="p">,</span> <span class="m">0</span><span class="n">x14</span><span class="p">,</span> <span class="m">0</span><span class="n">x83</span><span class="p">,</span> <span class="m">0</span><span class="n">xad</span><span class="p">,</span> <span class="m">0</span><span class="n">x3a</span><span class="p">,</span> <span class="m">0</span><span class="n">xf1</span><span class="p">,</span> <span class="m">0</span><span class="n">x66</span><span class="p">,</span> <span class="m">0</span><span class="n">x48</span><span class="p">,</span> <span class="m">0</span><span class="n">xdf</span><span class="p">,</span>
            <span class="m">0</span><span class="n">x10</span><span class="p">,</span> <span class="m">0</span><span class="n">x87</span><span class="p">,</span> <span class="m">0</span><span class="n">xa9</span><span class="p">,</span> <span class="m">0</span><span class="n">x3e</span><span class="p">,</span> <span class="m">0</span><span class="n">xf5</span><span class="p">,</span> <span class="m">0</span><span class="n">x62</span><span class="p">,</span> <span class="m">0</span><span class="n">x4c</span><span class="p">,</span> <span class="m">0</span><span class="n">xdb</span><span class="p">,</span> <span class="m">0</span><span class="n">x4d</span><span class="p">,</span> <span class="m">0</span><span class="n">xda</span><span class="p">,</span> <span class="m">0</span><span class="n">xf4</span><span class="p">,</span> <span class="m">0</span><span class="n">x63</span><span class="p">,</span> <span class="m">0</span><span class="n">xa8</span><span class="p">,</span> <span class="m">0</span><span class="n">x3f</span><span class="p">,</span> <span class="m">0</span><span class="n">x11</span><span class="p">,</span> <span class="m">0</span><span class="n">x86</span><span class="p">,</span>
            <span class="m">0</span><span class="n">xaa</span><span class="p">,</span> <span class="m">0</span><span class="n">x3d</span><span class="p">,</span> <span class="m">0</span><span class="n">x13</span><span class="p">,</span> <span class="m">0</span><span class="n">x84</span><span class="p">,</span> <span class="m">0</span><span class="n">x4f</span><span class="p">,</span> <span class="m">0</span><span class="n">xd8</span><span class="p">,</span> <span class="m">0</span><span class="n">xf6</span><span class="p">,</span> <span class="m">0</span><span class="n">x61</span><span class="p">,</span> <span class="m">0</span><span class="n">xf7</span><span class="p">,</span> <span class="m">0</span><span class="n">x60</span><span class="p">,</span> <span class="m">0</span><span class="n">x4e</span><span class="p">,</span> <span class="m">0</span><span class="n">xd9</span><span class="p">,</span> <span class="m">0</span><span class="n">x12</span><span class="p">,</span> <span class="m">0</span><span class="n">x85</span><span class="p">,</span> <span class="m">0</span><span class="n">xab</span><span class="p">,</span> <span class="m">0</span><span class="n">x3c</span>
        <span class="p">};</span>

 <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">checkCRC</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">Data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">bool</span> <span class="n">result</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

            <span class="kt">int</span> <span class="n">Crc</span> <span class="p">=</span> <span class="m">0</span><span class="n">xFF</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">Index</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">Data_Len</span> <span class="p">=</span> <span class="n">Data</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>

            <span class="c1">// length -1 because the last byte is the crc</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">Data</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">Index</span> <span class="p">=</span> <span class="n">Crc</span> <span class="p">^</span> <span class="n">Data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">Crc</span> <span class="p">=</span> <span class="n">mCrcTable</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span> <span class="p">&amp;</span> <span class="m">0</span><span class="n">xFF</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">Crc</span> <span class="p">&amp;=</span> <span class="m">0</span><span class="n">xFF</span><span class="p">;</span>

            <span class="c1">// Check against the provided one</span>
            <span class="kt">int</span> <span class="n">givenCRC</span> <span class="p">=</span> <span class="n">Data</span><span class="p">[</span><span class="n">Data</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Crc</span> <span class="p">==</span> <span class="n">givenCRC</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">result</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div>
</td></tr></table>

</div>
<input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><label for="__tabbed_5_2">Objective-C (iOS)</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cm">/*--------------------------------------------------------------------------------------------------</span>
<span class="cm"> @brief          Compares the check value in the provided data to the result of the CRC performed</span>
<span class="cm"> @param          data - the data on which to perform the CRC. Note the last byte must include the</span>
<span class="cm">                 provided check value</span>
<span class="cm"> @retval         YES if the check values match, NO otherwise</span>
<span class="cm"> --------------------------------------------------------------------------------------------------*/</span>

<span class="p">+(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isCrcValid:</span><span class="p">(</span><span class="bp">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span>
<span class="p">{</span>
    <span class="kt">BOOL</span> <span class="n">valid</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>

    <span class="cm">/* The CRC Table */</span>
    <span class="kt">int</span> <span class="n">crcTable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span>
        <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span>
        <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span>
        <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span>
        <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span>
        <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span>
        <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
        <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span>
        <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>
        <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span>
        <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span>
        <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span>
        <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span>
        <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span>
        <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span>
        <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x3c</span>
    <span class="p">};</span>

    <span class="cm">/* The parameters for the calculation */</span>
    <span class="kt">int</span> <span class="n">checkValue</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">dataLen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

    <span class="cm">/* The check value provided in the last byte of the data */</span>
    <span class="kt">int</span> <span class="n">givenCheckValue</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)[[</span><span class="n">data</span> <span class="nl">subdataWithRange</span><span class="p">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="n">dataLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="n">bytes</span><span class="p">];</span>

    <span class="cm">/* Perform the CRC */</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">dataLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">checkValue</span> <span class="o">^</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)[[</span><span class="n">data</span> <span class="nl">subdataWithRange</span><span class="p">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="n">bytes</span><span class="p">];</span>
        <span class="n">checkValue</span> <span class="o">=</span> <span class="n">crcTable</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">checkValue</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span><span class="p">;</span>

    <span class="cm">/* Check the result */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">checkValue</span> <span class="o">==</span> <span class="n">givenCheckValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>

</div>
</div>
<hr />
<h2 id="more-sample-code">more sample code<a class="headerlink" href="#more-sample-code" title="Permanent link">#</a></h2>
<div class="tabbed-set" data-tabs="6:4"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><label for="__tabbed_6_1">sample DoseRecord class</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DoseRecord</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">DOSE_ERROR_FLAG</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">TIME_ERROR_FLAG</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">LOW_VOLTAGE_FLAG</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">FAST_DOSE_FLAG</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">ALL_FLAGS</span> <span class="p">=</span> <span class="m">0</span><span class="n">xFF</span><span class="p">;</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">        Module Variables</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Timestamp</span><span class="p">;</span> <span class="c1">// stored as minutes since first use</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Dose</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Flags</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">CRC</span><span class="p">;</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="n">crcValid</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">timeError</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">        Global FUNCTIONS</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">        FUNCTION: DoseRecord</span>
<span class="cm">        Description: Constructor method.</span>
<span class="cm">        Param: None</span>
<span class="cm">        Return: DoseRecord</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="nf">DoseRecord</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Timestamp</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
            <span class="n">Dose</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
            <span class="n">Flags</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
            <span class="n">CRC</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">        FUNCTION: fromPackedDoseRecord</span>
<span class="cm">        Description: Converts a packed dose record as received to a DoseRecord as defined above</span>
<span class="cm">        Param: packedRecord - the record to convert</span>
<span class="cm">        Return: DoseRecord - the unpacked record</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">DoseRecord</span> <span class="nf">fromPackedDoseRecord</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">packedRecord</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DoseRecord</span> <span class="n">unpackedRecord</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DoseRecord</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">packedRecord</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">unpackedRecord</span><span class="p">.</span><span class="n">crcValid</span> <span class="p">=</span> <span class="n">Utils</span><span class="p">.</span><span class="n">checkCRC</span><span class="p">(</span><span class="n">packedRecord</span><span class="p">,</span> <span class="n">packedRecord</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">packedRecord</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">5</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">//Bit shift the timestamp bytes to get the 21 bit value</span>
                    <span class="kt">int</span> <span class="n">upperTimestamp</span> <span class="p">=</span> <span class="n">packedRecord</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">&lt;&lt;</span> <span class="m">13</span><span class="p">;</span>
                    <span class="kt">int</span> <span class="n">midTimestamp</span> <span class="p">=</span> <span class="n">packedRecord</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">&lt;&lt;</span> <span class="m">5</span><span class="p">;</span>
                    <span class="kt">int</span> <span class="n">lowerTimestamp</span> <span class="p">=</span> <span class="n">packedRecord</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">&gt;&gt;</span> <span class="m">3</span><span class="p">;</span>

                    <span class="n">unpackedRecord</span><span class="p">.</span><span class="n">Timestamp</span> <span class="p">=</span> <span class="n">upperTimestamp</span> <span class="p">|</span> <span class="n">midTimestamp</span> <span class="p">|</span> <span class="n">lowerTimestamp</span><span class="p">;</span>

                    <span class="c1">//Bit shift the dose bytes to get the 7 bit value</span>
                    <span class="kt">int</span> <span class="n">upperDose</span> <span class="p">=</span> <span class="p">(</span><span class="n">packedRecord</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">&amp;</span> <span class="m">0</span><span class="n">x07</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="m">4</span><span class="p">;</span>
                    <span class="kt">int</span> <span class="n">lowerDose</span> <span class="p">=</span> <span class="p">(</span><span class="n">packedRecord</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">&amp;</span> <span class="m">0</span><span class="n">xF0</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="m">4</span><span class="p">;</span>

                    <span class="n">unpackedRecord</span><span class="p">.</span><span class="n">Dose</span> <span class="p">=</span> <span class="n">upperDose</span> <span class="p">|</span> <span class="n">lowerDose</span><span class="p">;</span>

                    <span class="c1">//Copy the flags and crc bytes</span>
                    <span class="n">unpackedRecord</span><span class="p">.</span><span class="n">Flags</span> <span class="p">=</span> <span class="n">packedRecord</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">&amp;</span> <span class="m">0</span><span class="n">x0F</span><span class="p">;</span>
                    <span class="n">unpackedRecord</span><span class="p">.</span><span class="n">CRC</span> <span class="p">=</span> <span class="n">packedRecord</span><span class="p">[</span><span class="m">4</span><span class="p">];</span>

                    <span class="c1">//Check the time error flag</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">unpackedRecord</span><span class="p">.</span><span class="n">Flags</span> <span class="p">&amp;</span> <span class="m">0</span><span class="n">x4</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">unpackedRecord</span><span class="p">.</span><span class="n">timeError</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">unpackedRecord</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></table>

</div>
<input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><label for="__tabbed_6_2">sample DeviceDataManager class</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DeviceDataManager</span>
    <span class="p">{</span>
        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            MODULE variables</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="kt">string</span> <span class="n">mGtin</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">mLotNo</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">mProductionDate</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">mSoftwareRevision</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">mSerialNumber</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">mProductColour</span><span class="p">;</span>

        <span class="kt">string</span> <span class="n">mUdi</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">mTime</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">mGtinLength</span> <span class="p">=</span> <span class="m">14</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mLotNoLength</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mProductionDateLen</span> <span class="p">=</span> <span class="m">6</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mSerialNumberLength</span> <span class="p">=</span> <span class="m">8</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mSoftwareRevisionLength</span> <span class="p">=</span> <span class="m">8</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mProductColourLength</span> <span class="p">=</span> <span class="m">6</span><span class="p">;</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            Global FUNCTIONS</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the GTIN</span>

<span class="cm">            @return GTIN</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetGtin</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mGtin</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the lot number</span>

<span class="cm">            @return lot number</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetLotNo</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mLotNo</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the production date</span>

<span class="cm">            @return production date</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetProductionDate</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mProductionDate</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the serial number</span>

<span class="cm">            @return Serial number</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetSerialNumber</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mSerialNumber</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the software revision</span>

<span class="cm">            @return software revision</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetSoftwareRevision</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mSoftwareRevision</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the product colour</span>

<span class="cm">            @return product colour</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetProductColour</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mProductColour</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the UDI</span>

<span class="cm">            @return UDI</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetUdi</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mUdi</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">             @brief Updates the UDI</span>
<span class="cm">         -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ProcessUdi</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="cm">/* Process the characteristic value and set the module variable */</span>
                <span class="n">mUdi</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;UDI: &quot;</span> <span class="p">+</span> <span class="n">mUdi</span><span class="p">);</span>

                <span class="cm">/* Extract the GTIN */</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">gtinSeparator</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;(01)&quot;</span> <span class="p">};</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">gtinComponents</span> <span class="p">=</span> <span class="n">mUdi</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">gtinSeparator</span><span class="p">,</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>

                <span class="cm">/* Check the GTIN was actually present */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">gtinComponents</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">mGtin</span> <span class="p">=</span> <span class="n">gtinComponents</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">mGtinLength</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">mGtin</span> <span class="p">=</span> <span class="s">&quot;Failed to retrieve&quot;</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="cm">/* Extract the lot number */</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">lotNumberSeparator</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;(10)&quot;</span> <span class="p">};</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">lotNumberComponents</span> <span class="p">=</span> <span class="n">mUdi</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">lotNumberSeparator</span><span class="p">,</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>

                <span class="cm">/* Check the lot number was actually present */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lotNumberComponents</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">mLotNo</span> <span class="p">=</span> <span class="n">lotNumberComponents</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">mLotNoLength</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">mLotNo</span> <span class="p">=</span> <span class="s">&quot;Failed to retrieve&quot;</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="cm">/* Extract the production date */</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">productionDateSeparator</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;(11)&quot;</span> <span class="p">};</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">productionDateComponents</span> <span class="p">=</span> <span class="n">mUdi</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">productionDateSeparator</span><span class="p">,</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>

                <span class="cm">/* Check the production date was actually present */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">productionDateComponents</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">string</span> <span class="n">dateString</span> <span class="p">=</span> <span class="n">productionDateComponents</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">mProductionDateLen</span><span class="p">);</span>

                    <span class="n">mProductionDate</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">ParseExact</span><span class="p">(</span><span class="n">dateString</span><span class="p">,</span> <span class="s">&quot;yyMMdd&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">CultureInfo</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)).</span><span class="n">ToString</span><span class="p">(</span><span class="s">&quot;dd/MM/yy&quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">mProductionDate</span> <span class="p">=</span> <span class="s">&quot;Failed to retrieve&quot;</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="cm">/* Extract the serial number */</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">serialNumberSeparator</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;(21)&quot;</span> <span class="p">};</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">serialNumberComponents</span> <span class="p">=</span> <span class="n">mUdi</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">serialNumberSeparator</span><span class="p">,</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>

                <span class="cm">/* Check the serial number was actually present */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">serialNumberComponents</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">mSerialNumber</span> <span class="p">=</span> <span class="n">serialNumberComponents</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">mSerialNumberLength</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">mSerialNumber</span> <span class="p">=</span> <span class="s">&quot;Failed to retrieve&quot;</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="cm">/* Extract the software revision */</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">softwareRevisionSeparator</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;(91)&quot;</span> <span class="p">};</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">softwareRevisionComponents</span> <span class="p">=</span> <span class="n">mUdi</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">softwareRevisionSeparator</span><span class="p">,</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>

                <span class="cm">/* Check the software revision was actually present */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">softwareRevisionComponents</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">mSoftwareRevision</span> <span class="p">=</span> <span class="n">softwareRevisionComponents</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">mSoftwareRevisionLength</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">mSoftwareRevision</span> <span class="p">=</span> <span class="s">&quot;Failed to retrieve&quot;</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="cm">/* Extract the product colour */</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">productColourSeparator</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;(92)&quot;</span> <span class="p">};</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">productColourComponents</span> <span class="p">=</span> <span class="n">mUdi</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">productColourSeparator</span><span class="p">,</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>

                <span class="cm">/* Check the product colour was actually present */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">productColourComponents</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">mProductColour</span> <span class="p">=</span> <span class="n">productColourComponents</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">mProductColourLength</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">mProductColour</span> <span class="p">=</span> <span class="s">&quot;Failed to retrieve&quot;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the Time</span>

<span class="cm">            @return UDI</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetTime</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mTime</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">             @brief Updates the Time</span>
<span class="cm">         -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ProcessTime</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="cm">/* Get the numeric value of the date and time */</span>
                <span class="kt">int</span> <span class="n">timeOffset</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>

                <span class="cm">/* Convert to a date time */</span>
                <span class="n">DateTime</span> <span class="n">currentTime</span> <span class="p">=</span> <span class="n">Utils</span><span class="p">.</span><span class="n">StartDate</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="n">timeOffset</span><span class="p">);</span>

                <span class="cm">/* Convert to a string format */</span>
                <span class="kt">string</span> <span class="n">dateFormat</span> <span class="p">=</span> <span class="s">&quot;dd/MM/yy HH:mm:ss&quot;</span><span class="p">;</span>
                <span class="n">mTime</span> <span class="p">=</span> <span class="n">currentTime</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="n">dateFormat</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Resets the device data</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ResetDeviceData</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">mGtin</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">mLotNo</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">mProductionDate</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">mSerialNumber</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">mSoftwareRevision</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">mProductColour</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">mUdi</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">mTime</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></table>

</div>
<input id="__tabbed_6_3" name="__tabbed_6" type="radio" /><label for="__tabbed_6_3">sample DoseDataManager class</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DoseDataManager</span>
    <span class="p">{</span>
        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            MODULE variables</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="kt">string</span> <span class="n">TAG</span> <span class="p">=</span> <span class="s">&quot;DOSE DATA MGR &quot;</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">EXT_DOSE_RECORD_LEN</span> <span class="p">=</span> <span class="m">14</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">FIRST_USE_TIME_POS</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">DOSE_NUMBER_POS</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">DOSE_RECORD_POS</span> <span class="p">=</span> <span class="m">6</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">BATT_VOLTAGE_POS</span> <span class="p">=</span> <span class="m">11</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">TEMP_POS</span> <span class="p">=</span> <span class="m">12</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">CRC_POS</span> <span class="p">=</span> <span class="m">13</span><span class="p">;</span>

        <span class="n">List</span><span class="p">&lt;</span><span class="n">ExtendedDoseRecord</span><span class="p">&gt;</span> <span class="n">mRecordList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ExtendedDoseRecord</span><span class="p">&gt;();</span>

        <span class="kt">string</span> <span class="n">mBatteryVoltage</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">mTemperature</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mStartMissingRecord</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mEndMissingRecord</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>

        <span class="kt">bool</span> <span class="n">mRequestedRecordsReceived</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

        <span class="n">DoseHistory</span> <span class="n">mDoseHistory</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">enum</span> <span class="n">DoseDataType</span>
        <span class="p">{</span>
            <span class="n">tExtendedDoseRecord</span><span class="p">,</span>
            <span class="n">tRecordResponse</span>
        <span class="p">};</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            Global FUNCTIONS</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="nf">DoseDataManager</span><span class="p">(</span><span class="n">DoseHistory</span> <span class="n">doseHistory</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">mDoseHistory</span> <span class="p">=</span> <span class="n">doseHistory</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Clears the dose history</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ClearDoseHistory</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">mRecordList</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span> 
                <span class="n">mRecordList</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
                <span class="n">mDoseHistory</span><span class="p">.</span><span class="n">UpdateDoseHistory</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
                <span class="n">mDoseHistory</span><span class="p">.</span><span class="n">UpdateDoseHistoryStrings</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>       

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Processes the data received on the ExtendedDoseRecord characteristic</span>

<span class="cm">            @return True if records are missing, false otherwise</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="n">EdrStatus</span> <span class="nf">ProcessExtendedDoseRecordData</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ClearDoseHistory</span><span class="p">();</span>

            <span class="n">EdrStatus</span> <span class="n">edrStatus</span> <span class="p">=</span> <span class="n">EdrStatus</span><span class="p">.</span><span class="n">edrEmpty</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">edrStatus</span> <span class="p">=</span> <span class="n">CheckIfContainsDoseRecord</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">edrStatus</span> <span class="p">==</span> <span class="n">EdrStatus</span><span class="p">.</span><span class="n">edrOK</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="cm">/* Extract the Extended Dose Record from the data */</span>
                    <span class="n">ExtendedDoseRecord</span> <span class="n">record</span> <span class="p">=</span> <span class="n">ExtractExtendedDoseRecord</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

                    <span class="cm">/* Add the Extended Dose Record to the Dose History */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">record</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">AddExtendedDoseRecord</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>

                        <span class="n">SortDoseHistory</span><span class="p">();</span>

                        <span class="cm">/* Check for missing Dose Records if auto sync is enabled*/</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">AppSettings</span><span class="p">.</span><span class="n">AUTO_SYNC</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">CheckMissingRecords</span><span class="p">())</span>
                            <span class="p">{</span>
                                <span class="n">edrStatus</span> <span class="p">=</span> <span class="n">EdrStatus</span><span class="p">.</span><span class="n">edrRecordsMissing</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="cm">/* Update the list */</span>
                <span class="n">mDoseHistory</span><span class="p">.</span><span class="n">UpdateDoseHistory</span><span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ExtendedDoseRecord</span><span class="p">&gt;(</span><span class="n">mRecordList</span><span class="p">));</span>
                <span class="n">UpdateDoseHistoryStrings</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;ProcessExtendedDoseRecordData: data = null&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">edrStatus</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">           @brief Processes the data received on the RecordResponse characteristic</span>

<span class="cm">           @return True if records are missing, false otherwise</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">ProcessRecordResponseData</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">bool</span> <span class="n">missingRecords</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="cm">/* Reset the record monitor */</span>
                <span class="n">mRequestedRecordsReceived</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

                <span class="cm">/* Extract the Dose Records from the data and add them to the Dose History*/</span>
                <span class="n">ExtractDoseRecords</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

                <span class="cm">/* Check for missing Dose Records if auto sync is enabled and we received all requested */</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">AppSettings</span><span class="p">.</span><span class="n">AUTO_SYNC</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">mRequestedRecordsReceived</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">missingRecords</span> <span class="p">=</span> <span class="n">CheckMissingRecords</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="cm">/* Update the list */</span>
                <span class="n">mDoseHistory</span><span class="p">.</span><span class="n">UpdateDoseHistory</span><span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ExtendedDoseRecord</span><span class="p">&gt;(</span><span class="n">mRecordList</span><span class="p">));</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">mRequestedRecordsReceived</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">UpdateDoseHistoryStrings</span><span class="p">();</span>
                <span class="p">}</span>

            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;ProcessRecordResponseData: data = null&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">missingRecords</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Update the dose history strings with the latest record list</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">UpdateDoseHistoryStrings</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">mDoseHistory</span><span class="p">.</span><span class="n">UpdateDoseHistoryStrings</span><span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ExtendedDoseRecord</span><span class="p">&gt;(</span><span class="n">mRecordList</span><span class="p">));</span>
        <span class="p">}</span>


        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">           @brief Identifies any missing records</span>

<span class="cm">           @return array holding first and last missing records</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">int</span><span class="p">[]</span> <span class="nf">GetMissingRecords</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">int</span><span class="p">[]</span> <span class="n">missingRecords</span> <span class="p">=</span> <span class="p">{</span> <span class="n">mStartMissingRecord</span><span class="p">,</span> <span class="n">mEndMissingRecord</span> <span class="p">};</span>

            <span class="k">return</span> <span class="n">missingRecords</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the battery voltage</span>

<span class="cm">            @return Battery voltage as a string</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetBatteryVoltage</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mBatteryVoltage</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Returns the temperature</span>

<span class="cm">            @return temperature as a string</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetTemperature</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mTemperature</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Determines whether or not all requested records have been received</span>

<span class="cm">            @return true if they have all been received, false otherwise</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">RequestedRecordsReceived</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">mRequestedRecordsReceived</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Updates the start and end missing records</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ManualRequest</span><span class="p">(</span><span class="kt">int</span><span class="p">[]</span> <span class="n">recordNumbers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">mStartMissingRecord</span> <span class="p">=</span> <span class="n">recordNumbers</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
            <span class="n">mEndMissingRecord</span> <span class="p">=</span> <span class="n">recordNumbers</span><span class="p">[</span><span class="m">1</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            Module FUNCTIONS</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Check if the Extended Dose Record data contains a Dose Record</span>

<span class="cm">            @return erdOK if a dose record is present</span>
<span class="cm">                    edrEmpty if the data is all zeros</span>
<span class="cm">                    edrNoRecords if the data indicates no records are stored</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">private</span> <span class="n">EdrStatus</span> <span class="nf">CheckIfContainsDoseRecord</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">EdrStatus</span> <span class="n">status</span> <span class="p">=</span> <span class="n">EdrStatus</span><span class="p">.</span><span class="n">edrEmpty</span><span class="p">;</span>

            <span class="cm">/* Check if it&#39;s an empty record (this can happen in pairing mode) */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">status</span> <span class="p">=</span> <span class="n">EdrStatus</span><span class="p">.</span><span class="n">edrOK</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>


                <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="p">==</span> <span class="n">EdrStatus</span><span class="p">.</span><span class="n">edrOK</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">status</span> <span class="p">=</span> <span class="n">EdrStatus</span><span class="p">.</span><span class="n">edrNoRecords</span><span class="p">;</span>

                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">status</span> <span class="p">=</span> <span class="n">EdrStatus</span><span class="p">.</span><span class="n">edrOK</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;CheckIfContainsDoseRecord: data = null&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Extract an Extended Dose Record from the given data</span>

<span class="cm">            @return the extracted record</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">private</span> <span class="n">ExtendedDoseRecord</span> <span class="nf">ExtractExtendedDoseRecord</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ExtendedDoseRecord</span> <span class="n">record</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ExtendedDoseRecord</span><span class="p">();</span>
            <span class="n">record</span><span class="p">.</span><span class="n">DataCaptureTimestamp</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="cm">/* Extract the first use time */</span>
                <span class="n">ExtendedDoseRecord</span><span class="p">.</span><span class="n">FirstUseTime</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FIRST_USE_TIME_POS</span> <span class="p">+</span> <span class="m">3</span><span class="p">]</span> <span class="p">*</span> <span class="m">256</span> <span class="p">*</span> <span class="m">256</span> <span class="p">*</span> <span class="m">256</span> <span class="p">+</span>
                                                  <span class="n">data</span><span class="p">[</span><span class="n">FIRST_USE_TIME_POS</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">*</span> <span class="m">256</span> <span class="p">*</span> <span class="m">256</span> <span class="p">+</span>
                                                  <span class="n">data</span><span class="p">[</span><span class="n">FIRST_USE_TIME_POS</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">*</span> <span class="m">256</span> <span class="p">+</span>
                                                  <span class="n">data</span><span class="p">[</span><span class="n">FIRST_USE_TIME_POS</span> <span class="p">+</span> <span class="m">0</span><span class="p">];</span>

                <span class="n">record</span><span class="p">.</span><span class="n">DoseNumber</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">DOSE_NUMBER_POS</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">*</span> <span class="m">256</span> <span class="p">+</span>
                                    <span class="n">data</span><span class="p">[</span><span class="n">DOSE_NUMBER_POS</span><span class="p">];</span>

                <span class="cm">/* Extract the dose record */</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">packedRecord</span> <span class="p">=</span> <span class="p">{</span><span class="n">data</span><span class="p">[</span><span class="n">DOSE_RECORD_POS</span><span class="p">],</span>
                                   <span class="n">data</span><span class="p">[</span><span class="n">DOSE_RECORD_POS</span> <span class="p">+</span> <span class="m">1</span><span class="p">],</span>
                                   <span class="n">data</span><span class="p">[</span><span class="n">DOSE_RECORD_POS</span> <span class="p">+</span> <span class="m">2</span><span class="p">],</span>
                                   <span class="n">data</span><span class="p">[</span><span class="n">DOSE_RECORD_POS</span> <span class="p">+</span> <span class="m">3</span><span class="p">],</span>
                                   <span class="n">data</span><span class="p">[</span><span class="n">DOSE_RECORD_POS</span> <span class="p">+</span> <span class="m">4</span><span class="p">]};</span>


                <span class="n">record</span><span class="p">.</span><span class="n">DoseRecord</span> <span class="p">=</span> <span class="n">DoseRecord</span><span class="p">.</span><span class="n">fromPackedDoseRecord</span><span class="p">(</span><span class="n">packedRecord</span><span class="p">);</span>

                <span class="cm">/* Extract the battery voltage and temperature */</span>
                <span class="n">record</span><span class="p">.</span><span class="n">BatteryVoltage</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">BATT_VOLTAGE_POS</span><span class="p">]</span> <span class="p">*</span> <span class="m">15.625</span> <span class="p">/</span> <span class="m">1000</span><span class="p">;</span>
                <span class="n">record</span><span class="p">.</span><span class="n">Temperature</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">TEMP_POS</span><span class="p">];</span>

                <span class="cm">/* Extract and check the CRC */</span>
                <span class="n">record</span><span class="p">.</span><span class="n">CRC</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">CRC_POS</span><span class="p">];</span>
                <span class="n">record</span><span class="p">.</span><span class="n">CrcValid</span> <span class="p">=</span> <span class="n">Utils</span><span class="p">.</span><span class="n">checkCRC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT_DOSE_RECORD_LEN</span><span class="p">);</span>

                <span class="cm">/* Update the battery voltage and temperature */</span>
                <span class="n">mBatteryVoltage</span> <span class="p">=</span> <span class="n">record</span><span class="p">.</span><span class="n">BatteryVoltage</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="s">&quot;0.00&quot;</span><span class="p">);</span>
                <span class="n">mTemperature</span> <span class="p">=</span> <span class="n">record</span><span class="p">.</span><span class="n">Temperature</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>

                <span class="cm">/* Add an * if the CRC was incorrect */</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">record</span><span class="p">.</span><span class="n">CrcValid</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">mBatteryVoltage</span> <span class="p">+=</span> <span class="s">&quot;*&quot;</span><span class="p">;</span>
                    <span class="n">mTemperature</span> <span class="p">+=</span> <span class="s">&quot;*&quot;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;ExtractExtendedDoseRecord: data = null&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">record</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Extract a set of Dose Records from the given data and add to the dose history</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">ExtractDoseRecords</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">List</span><span class="p">&lt;</span><span class="n">ExtendedDoseRecord</span><span class="p">&gt;</span> <span class="n">recordList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ExtendedDoseRecord</span><span class="p">&gt;();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="cm">/* Extract the number of records in the response */</span>
                <span class="kt">int</span> <span class="n">recordCount</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>

                <span class="cm">/* Extract the dose number of the first record */</span>
                <span class="kt">int</span> <span class="n">startingDoseNumber</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">&lt;&lt;</span> <span class="m">8</span><span class="p">);</span>

                <span class="cm">/* Extract each dose record */</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">recordCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="cm">/* Calculate the offset for that record */</span>
                    <span class="kt">int</span> <span class="n">offset</span> <span class="p">=</span> <span class="m">3</span> <span class="p">+</span> <span class="m">5</span> <span class="p">*</span> <span class="n">i</span><span class="p">;</span>

                    <span class="cm">/* Extract the record */</span>
                    <span class="kt">byte</span><span class="p">[]</span> <span class="n">packedRecord</span> <span class="p">=</span> <span class="p">{</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span>
                                       <span class="n">data</span><span class="p">[</span><span class="n">offset</span> <span class="p">+</span> <span class="m">1</span><span class="p">],</span>
                                       <span class="n">data</span><span class="p">[</span><span class="n">offset</span> <span class="p">+</span> <span class="m">2</span><span class="p">],</span>
                                       <span class="n">data</span><span class="p">[</span><span class="n">offset</span> <span class="p">+</span> <span class="m">3</span><span class="p">],</span>
                                       <span class="n">data</span><span class="p">[</span><span class="n">offset</span> <span class="p">+</span> <span class="m">4</span><span class="p">]};</span>

                    <span class="cm">/* Create an extended dose record from the dose record */</span>
                    <span class="n">DoseRecord</span> <span class="n">record</span> <span class="p">=</span> <span class="n">DoseRecord</span><span class="p">.</span><span class="n">fromPackedDoseRecord</span><span class="p">(</span><span class="n">packedRecord</span><span class="p">);</span>
                    <span class="kt">int</span> <span class="n">doseNumber</span> <span class="p">=</span> <span class="n">startingDoseNumber</span> <span class="p">+</span> <span class="n">i</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">record</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">ExtendedDoseRecord</span> <span class="n">extRecord</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ExtendedDoseRecord</span><span class="p">(</span><span class="n">doseNumber</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>

                        <span class="cm">/* Add the extended dose record to the Dose History */</span>
                        <span class="n">AddExtendedDoseRecord</span><span class="p">(</span><span class="n">extRecord</span><span class="p">);</span>

                        <span class="cm">/* Set the flag to show all requested records were received if we get the last one */</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">extRecord</span><span class="p">.</span><span class="n">DoseNumber</span> <span class="p">==</span> <span class="n">mEndMissingRecord</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">mRequestedRecordsReceived</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="cm">/* Sort the dose history */</span>
                <span class="n">SortDoseHistory</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;ExtractDoseRecords: data = null&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Adds an Extended Dose Record to the Dose History</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">AddExtendedDoseRecord</span><span class="p">(</span><span class="n">ExtendedDoseRecord</span> <span class="n">newRecord</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newRecord</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mRecordList</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">mRecordList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ExtendedDoseRecord</span><span class="p">&gt;();</span>
                <span class="p">}</span>

                <span class="cm">/* Check if the record already exists */</span>
                <span class="kt">bool</span> <span class="n">recordExists</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="n">ExtendedDoseRecord</span> <span class="n">existingRecord</span> <span class="k">in</span> <span class="n">mRecordList</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">existingRecord</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">existingRecord</span><span class="p">.</span><span class="n">DoseNumber</span> <span class="p">==</span> <span class="n">newRecord</span><span class="p">.</span><span class="n">DoseNumber</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">recordExists</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="cm">/* Don&#39;t check for existing records if REPEATS_ALLOWED is ticked */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">AppSettings</span><span class="p">.</span><span class="n">REPEATS_ALLOWED</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">mRecordList</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">newRecord</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="cm">/* If the record doesn&#39;t exist, add it to the Dose History */</span>
                    <span class="k">if</span> <span class="p">(!</span><span class="n">recordExists</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">mRecordList</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">newRecord</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;AddExtendedDoseRecord: data = null&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Checks Dose History for missing records</span>

<span class="cm">            @return true if records are missing, false otherwise</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">CheckMissingRecords</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">bool</span> <span class="n">recordsMissing</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">mRecordList</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="cm">/* Scan through Dose History to find missing records */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mRecordList</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="cm">/* Identify the oldest record */</span>
                    <span class="n">ExtendedDoseRecord</span> <span class="n">oldestRecord</span> <span class="p">=</span> <span class="n">mRecordList</span><span class="p">[</span><span class="n">mRecordList</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">];</span>

                    <span class="cm">/* Check the oldest record is record 0 */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">oldestRecord</span><span class="p">.</span><span class="n">DoseNumber</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">mStartMissingRecord</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                        <span class="n">mEndMissingRecord</span> <span class="p">=</span> <span class="n">oldestRecord</span><span class="p">.</span><span class="n">DoseNumber</span><span class="p">;</span>
                        <span class="n">recordsMissing</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="cm">/* Check if there are any other missing records */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">mRecordList</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">mRecordList</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                        <span class="p">{</span>
                            <span class="cm">/* Only look if missing records have not already been identified */</span>
                            <span class="k">if</span> <span class="p">(!</span><span class="n">recordsMissing</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="cm">/* Identify the next pair of records */</span>
                                <span class="kt">int</span> <span class="n">currentDoseNo</span> <span class="p">=</span> <span class="n">mRecordList</span><span class="p">[</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span><span class="p">].</span><span class="n">DoseNumber</span><span class="p">;</span>
                                <span class="kt">int</span> <span class="n">prevDoseNo</span> <span class="p">=</span> <span class="n">mRecordList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">DoseNumber</span><span class="p">;</span>

                                <span class="cm">/* Check that the dose numbers are consecutive */</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">currentDoseNo</span> <span class="p">-</span> <span class="n">prevDoseNo</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
                                <span class="p">{</span>
                                    <span class="n">mStartMissingRecord</span> <span class="p">=</span> <span class="n">prevDoseNo</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
                                    <span class="n">mEndMissingRecord</span> <span class="p">=</span> <span class="n">currentDoseNo</span><span class="p">;</span>

                                    <span class="cm">/* Stop looking for more gaps */</span>
                                    <span class="n">recordsMissing</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;CheckMissingRecords: data = null&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">recordsMissing</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*-----------------------------------------------------------------------------------------</span>
<span class="cm">            @brief Sorts the dose history by dose number</span>
<span class="cm">        -----------------------------------------------------------------------------------------*/</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">SortDoseHistory</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">mRecordList</span><span class="p">.</span><span class="n">Sort</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></table>

</div>
<input id="__tabbed_6_4" name="__tabbed_6" type="radio" /><label for="__tabbed_6_4">sample ECDH class</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ECDH</span>
    <span class="p">{</span>
        <span class="cm">/*--------------------------------------------------------------------------------------------------</span>
<span class="cm">          Global FUNCTIONS</span>
<span class="cm">        --------------------------------------------------------------------------------------------------*/</span>
        <span class="cm">/*--------------------------------------------------------------------------------------------------</span>
<span class="cm">            @brief          Simulates receiving the server public keys</span>
<span class="cm">            @retval         pair - a public/private key pair</span>
<span class="cm">        --------------------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="n">AsymmetricCipherKeyPair</span> <span class="nf">GenerateServerKeys</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">serverPublicKey</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* Parameters creation */</span>
            <span class="n">X9ECParameters</span> <span class="n">ecP</span> <span class="p">=</span> <span class="n">NistNamedCurves</span><span class="p">.</span><span class="n">GetByName</span><span class="p">(</span><span class="s">&quot;P-256&quot;</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">domainParameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ECDomainParameters</span><span class="p">(</span><span class="n">ecP</span><span class="p">.</span><span class="n">Curve</span><span class="p">,</span> <span class="n">ecP</span><span class="p">.</span><span class="n">G</span><span class="p">,</span> <span class="n">ecP</span><span class="p">.</span><span class="n">N</span><span class="p">,</span> <span class="n">ecP</span><span class="p">.</span><span class="n">H</span><span class="p">,</span> <span class="n">ecP</span><span class="p">.</span><span class="n">GetSeed</span><span class="p">());</span>


            <span class="kt">byte</span><span class="p">[]</span> <span class="n">publicKeyY</span> <span class="p">=</span>      <span class="p">{</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span>
                                       <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span>
                                       <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span>
                                       <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span> <span class="p">};</span>

            <span class="kt">byte</span><span class="p">[]</span> <span class="n">publicKeyX</span> <span class="p">=</span>      <span class="p">{</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span>
                                       <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span>
                                       <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span>
                                       <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span><span class="p">,</span> <span class="m">0</span><span class="n">x00</span> <span class="p">};</span>

            <span class="cm">/* Split the key into x and y coordinates */</span>
            <span class="n">Array</span><span class="p">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">serverPublicKey</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">publicKeyX</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">32</span><span class="p">);</span>
            <span class="n">Array</span><span class="p">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">serverPublicKey</span><span class="p">,</span> <span class="m">32</span><span class="p">,</span> <span class="n">publicKeyY</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">32</span><span class="p">);</span>

            <span class="kt">string</span> <span class="n">xString</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="n">publicKeyX</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">yString</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="n">publicKeyY</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

            <span class="cm">/* Convert from strings to big integers */</span>
            <span class="n">BigInteger</span> <span class="n">xInteger</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BigInteger</span><span class="p">(</span><span class="n">xString</span><span class="p">,</span> <span class="m">16</span><span class="p">);</span>
            <span class="n">BigInteger</span> <span class="n">yInteger</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BigInteger</span><span class="p">(</span><span class="n">yString</span><span class="p">,</span> <span class="m">16</span><span class="p">);</span>
            <span class="n">BigInteger</span> <span class="n">privateKey</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BigInteger</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="m">16</span><span class="p">);</span>

            <span class="cm">/* Create the point on the curve using the public x and y coordinates */</span>
            <span class="n">FpFieldElement</span> <span class="n">xCoord</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FpFieldElement</span><span class="p">(((</span><span class="n">FpCurve</span><span class="p">)</span><span class="n">ecP</span><span class="p">.</span><span class="n">Curve</span><span class="p">).</span><span class="n">Q</span><span class="p">,</span> <span class="n">xInteger</span><span class="p">);</span>
            <span class="n">FpFieldElement</span> <span class="n">yCoord</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FpFieldElement</span><span class="p">(((</span><span class="n">FpCurve</span><span class="p">)</span><span class="n">ecP</span><span class="p">.</span><span class="n">Curve</span><span class="p">).</span><span class="n">Q</span><span class="p">,</span> <span class="n">yInteger</span><span class="p">);</span>

            <span class="cm">/* Create the private and public keys */</span>
            <span class="n">ECPublicKeyParameters</span> <span class="n">publicKeyPoint</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ECPublicKeyParameters</span><span class="p">(</span><span class="k">new</span> <span class="n">FpPoint</span><span class="p">(</span><span class="n">ecP</span><span class="p">.</span><span class="n">Curve</span><span class="p">,</span> <span class="n">xCoord</span><span class="p">,</span> <span class="n">yCoord</span><span class="p">),</span> <span class="n">domainParameters</span><span class="p">);</span>
            <span class="n">ECPrivateKeyParameters</span> <span class="n">privateKeyPoint</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ECPrivateKeyParameters</span><span class="p">(</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">domainParameters</span><span class="p">);</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nf">AsymmetricCipherKeyPair</span><span class="p">(</span><span class="n">publicKeyPoint</span><span class="p">,</span> <span class="n">privateKeyPoint</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/*--------------------------------------------------------------------------------------------------</span>
<span class="cm">            @brief          Generates a public/private key pair for the client</span>
<span class="cm">            @retval         pair - a public/private key pair</span>
<span class="cm">        --------------------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="n">AsymmetricCipherKeyPair</span> <span class="nf">GenerateClientKeys</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="cm">/* using ECDH algorithm for the key generation */</span>
            <span class="kt">var</span> <span class="n">generator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ECKeyPairGenerator</span><span class="p">(</span><span class="s">&quot;ECDH&quot;</span><span class="p">);</span>

            <span class="cm">/* Create a random number */</span>
            <span class="kt">var</span> <span class="n">secureRandom</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SecureRandom</span><span class="p">();</span>

            <span class="cm">/* Parameters creation */</span>
            <span class="n">X9ECParameters</span> <span class="n">ecP</span> <span class="p">=</span> <span class="n">NistNamedCurves</span><span class="p">.</span><span class="n">GetByName</span><span class="p">(</span><span class="s">&quot;P-256&quot;</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">domainParameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ECDomainParameters</span><span class="p">(</span><span class="n">ecP</span><span class="p">.</span><span class="n">Curve</span><span class="p">,</span> <span class="n">ecP</span><span class="p">.</span><span class="n">G</span><span class="p">,</span> <span class="n">ecP</span><span class="p">.</span><span class="n">N</span><span class="p">,</span> <span class="n">ecP</span><span class="p">.</span><span class="n">H</span><span class="p">,</span> <span class="n">ecP</span><span class="p">.</span><span class="n">GetSeed</span><span class="p">());</span>
            <span class="kt">var</span> <span class="n">keyGenParam</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ECKeyGenerationParameters</span><span class="p">(</span><span class="n">domainParameters</span><span class="p">,</span> <span class="n">secureRandom</span><span class="p">);</span>

            <span class="cm">/* Initialise the generation algorithm with the Parameters */</span>
            <span class="n">generator</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">keyGenParam</span><span class="p">);</span>

            <span class="cm">/* Generate the Key Pair */</span>
            <span class="n">AsymmetricCipherKeyPair</span> <span class="n">pair</span> <span class="p">=</span> <span class="n">generator</span><span class="p">.</span><span class="n">GenerateKeyPair</span><span class="p">();</span>

            <span class="cm">/* Retrieve the private and public keys and convert to strings */</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">clientPrivateKey</span> <span class="p">=</span> <span class="p">((</span><span class="n">ECPrivateKeyParameters</span><span class="p">)</span><span class="n">pair</span><span class="p">.</span><span class="n">Private</span><span class="p">).</span><span class="n">D</span><span class="p">.</span><span class="n">ToByteArray</span><span class="p">();</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">clientPublicKey</span> <span class="p">=</span> <span class="p">((</span><span class="n">ECPublicKeyParameters</span><span class="p">)</span><span class="n">pair</span><span class="p">.</span><span class="n">Public</span><span class="p">).</span><span class="n">Q</span><span class="p">.</span><span class="n">GetEncoded</span><span class="p">();</span>

            <span class="kt">string</span> <span class="n">clientPrivateKeyString</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="n">clientPrivateKey</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">clientPublicKeyString</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="n">clientPublicKey</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

            <span class="cm">/* Split the public key into x and y coordinates */</span>
            <span class="kt">string</span> <span class="n">clientPublicKeyX</span> <span class="p">=</span> <span class="n">clientPublicKeyString</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">64</span><span class="p">);</span> <span class="cm">/* Bytes 1 - 32 */</span>
            <span class="kt">string</span> <span class="n">clientPublicKeyY</span> <span class="p">=</span> <span class="n">clientPublicKeyString</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="m">65</span><span class="p">);</span>    <span class="cm">/* Bytes 33 - 64 */</span>

            <span class="cm">/* Print out the keys */</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;PRIVATE KEY: &quot;</span> <span class="p">+</span> <span class="n">clientPrivateKeyString</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;PUBLIC KEY X: &quot;</span> <span class="p">+</span> <span class="n">clientPublicKeyX</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;PUBLIC KEY Y: &quot;</span> <span class="p">+</span> <span class="n">clientPublicKeyY</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">pair</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*--------------------------------------------------------------------------------------------------</span>
<span class="cm">            @brief          Generates a shared secret from the key pair</span>
<span class="cm">            @param          pair - a public/private key pair</span>
<span class="cm">            @retval         secret - the shared sectret</span>
<span class="cm">        --------------------------------------------------------------------------------------------------*/</span>
        <span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">GenerateSharedSecret</span><span class="p">(</span><span class="n">AsymmetricCipherKeyPair</span> <span class="n">pair</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* Initialize the agreement */</span>
            <span class="n">ECDHBasicAgreement</span> <span class="n">agreement</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ECDHBasicAgreement</span><span class="p">();</span>
            <span class="n">agreement</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">Private</span><span class="p">);</span>

            <span class="cm">/* Generate the shared secret */</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">secret</span> <span class="p">=</span> <span class="n">agreement</span><span class="p">.</span><span class="n">CalculateAgreement</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">Public</span><span class="p">).</span><span class="n">ToByteArray</span><span class="p">();</span>

            <span class="cm">/* Print out the secret */</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;SHARED SECRET (X): &quot;</span> <span class="p">+</span> <span class="n">secret</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">secret</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></table>

</div>
</div>
<hr />
<h2 id="different-formats">different formats<a class="headerlink" href="#different-formats" title="Permanent link">#</a></h2>
<p>sample checklist:</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" checked/><span class="task-list-indicator"></span></label> item 1<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" checked/><span class="task-list-indicator"></span></label> item A
    more text<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" checked/><span class="task-list-indicator"></span></label> item a</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> item a</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" checked/><span class="task-list-indicator"></span></label> item C</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox"/><span class="task-list-indicator"></span></label> item 2</li>
</ul>
<hr />
<p>Here is some <del class="critic"><em>incorrect</em></del> Markdown.  I am adding this<ins class="critic"> here</ins>.  Here is some more <del class="critic">text
 that I am removing</del>text.  And here is even more <ins class="critic">text that I 
 am </ins>adding.<del class="critic break">&nbsp;</del><ins class="critic">  </ins>Paragraph was deleted and replaced with some spaces.<del class="critic">  </del></p>
<ins class="critic break">&nbsp;</ins>
<p>Spaces were removed and a <span style="color:blue">paragraph</span> was added.</p>
<p>And here is a comment on <mark class="critic">some
 text</mark><span class="critic comment">This works quite well. I just wanted to comment on it.</span>. Substitutions <del class="critic">is</del><ins class="critic">are</ins> great!</p>
<p>This section gives an overview of CONNECTED DEVICE behaviours. </p>
<p>This section gives an overview of <em>Connected Device</em> behaviours. </p>
<p>This section gives an overview of <strong>Connected Device</strong> behaviours. </p>
<p>General block handling.</p>
<del class="critic block">
<ul>
<li>test remove</li>
<li>test remove</li>
<li>test remove<ul>
<li>test remove</li>
</ul>
</li>
<li>test remove</li>
</ul>
</del>
<ins class="critic block">
<ul>
<li>test add</li>
<li>test add</li>
<li>test add<ul>
<li>test add</li>
</ul>
</li>
<li>test add</li>
</ul>
</ins>
<hr />
<p><mark>mark me</mark></p>
<p><span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-alt">Alt</kbd><span>+</span><kbd>My Special Key</kbd></span></p>
<p><span class="keys"><kbd class="key-command">Cmd</kbd><span>+</span><kbd class="key-alt">Alt</kbd><span>+</span><kbd></kbd></span></p>
<blockquote>
<p>can have nested</p>
<blockquote>
<p>blockquotes inside of block quotes
block quotes can also contain any valid markdown</p>
</blockquote>
</blockquote>
<hr />
<h2 id="admonitions">admonitions<a class="headerlink" href="#admonitions" title="Permanent link">#</a></h2>
<details class="multiple optional-class" open="open"><summary>Summary</summary><p>Here's some content.</p>
<details class="note" open="open"><summary>Open styled details</summary><details class="danger" open="open"><summary>Nested details!</summary><p>And more content again.</p>
</details>
</details>
</details>
<details class="success" open="open"><summary>Success</summary><p>Content.</p>
<details class="warning classes"><summary>Warning</summary><p>Content.</p>
</details>
</details>
<div class="admonition info">
<p class="admonition-title">Info</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
</div>
<div class="admonition help">
<p class="admonition-title">Help</p>
</div>
<div class="admonition bug">
<p class="admonition-title">Bug</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
</div>
<div class="admonition failure">
<p class="admonition-title">Failure</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="contact.html" title="Contact" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Contact
              </div>
            </div>
          </a>
        
        
          <a href="glossary.html" title="Glossary" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Glossary
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/vendor.de50e36d.min.js"></script>
      <script src="assets/javascripts/bundle.ff925e8b.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      


      <script>
        app = initialize({
          base: ".",
          features: [],
          search: Object.assign({
            worker: "assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
      
        <script src="javascripts/jquery.fancybox.min.js"></script>
      
        <script src="javascripts/bootstrap.min.js"></script>
      
        <script src="javascripts/navbar_hover.js"></script>
      
    
  </body>
</html>